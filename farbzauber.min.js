var drawingBoardCanvas,isthere=false,loaddone=false,mainImage,originalCanvas,originalCanvasContext,brushCanvas,brushIO,brushIOimagedata,brushIOimagedatadata,brushIOimagedatadataA,brushsize=50,bsradius=Math.floor(brushsize/2),bsradius2=bsradius*bsradius,BrushCanvasCollection={},getImageCanvas=function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;oCanvasContext=b.getContext("2d");oCanvasContext.drawImage(a,0,0,b.width,b.height);return b},setBrushCanvas=function(a,b){var i=
false;if(b)if(BrushCanvasCollection[b]){i=true;brushCanvas=BrushCanvasCollection[b].canvas;brushIOimagedata=BrushCanvasCollection[b].data;brushIOimagedatadata=brushIOimagedata.data;brushIOimagedatadataA=BrushCanvasCollection[b].dataA}if(!i){if(typeof a=="function")a=a();brushCanvas=a;brushIO=$.inim.canvasIoFactory($(brushCanvas),true);brushIOimagedata=brushIO[1];brushIOimagedatadata=brushIOimagedata.data;brushIOimagedatadataA=[];for(a=0;a<brushIOimagedatadata.length;a++)brushIOimagedatadataA[a]=brushIOimagedatadata[a];
if(b)BrushCanvasCollection[b]={canvas:brushCanvas,data:brushIOimagedata,dataA:brushIOimagedatadataA}}if(b&&$("#"+b).get(0)){$(".circle").removeClass("high");$("#"+b).addClass("high");$("#brushsize").hide()}return this};
function handleFileSelect(a){a.stopPropagation();a.preventDefault();f=(a.target.files?a.target.files:a.dataTransfer.files)[0];if(f.type.match("image.*")){if(isthere===true){$("#list").empty();loaddone=false;BrushCanvasCollection={}}a=new FileReader;a.onloadstart=function(){};a.onerror=function(){};a.onload=function(){return function(b){var i=$(document.createElement("img"));mainImage=i[0];$(i).load(function(){if(loaddone===true)return this;loaddone=true;var c=drawingBoardCanvas;$(i).hide().appendTo("#list");
var v=this.width,x=this.height;if(this.width>$(window).width()){this.width=Math.floor($(window).width()*0.9);this.height=Math.floor(this.height*(this.width/v))}if(this.height>$(window).height()){this.height=Math.floor($(window).height()*0.9);if(v==this.width)this.width=Math.floor(this.width*(this.height/x))}originalCanvas=getImageCanvas(this);setBrushCanvas(originalCanvas,"color");c=$(i).inimImgCanvas(function(y){c=y;setBrushCanvas($(c));var m=brushIO[1].width,q=brushIO[1].height;$(c).inimBwOutline();
$("#start").hide();$(c).fadeIn(2E3).addClass("shadow");$("#tools").fadeIn(500).draggable({axis:"x",delay:200,start:function(){$("#brushsize").fadeOut(200)}});isthere=true;$(c).inimBwOutline();var r=$.inim.canvasIoFactory($(c),true),w=r[1],z=w.data,t=function(d,A){var h=$(A).offset(),e=d.pageX-h.left,j=d.pageY-h.top;h=e-bsradius;var k=j-bsradius,n=brushsize;if(n>m-h)n=m-h;else if(e<bsradius)n=e+bsradius;e=brushsize;if(e>q-k)e=q-k;else if(j<bsradius)e=j+bsradius;if(h<0||h+brushsize>m||k<0||k+brushsize>
q)j=e=false;else{e=r[0].getImageData(h,k,n,e);j=e.data}for(var o=0;o<brushsize;o++)for(var p=0;p<brushsize;p++){var g=o-bsradius;g*=g;var l=p-bsradius,B=l*l;l=h+o;var s=k+p;if(l>-1&&l<=m&&s>-1&&s<=q)if(g+B<bsradius2){g=$.inim.getPixelOpt(brushIOimagedatadataA,l,s,m);$.inim.setPixelOpt(z,l,s,g[2],g[3],g[4],g[5],m);j!==false&&$.inim.setPixelOpt(j,o,p,g[2],g[3],g[4],g[5],n)}}j===false?r[0].putImageData(w,0,0):r[0].putImageData(e,h,k)},u=false;$(c).mousemove(function(d){u&&t(d,this)});$(c).click(function(d){t(d,
this)});$(c).mousedown(function(){u=true});$(c).mouseup(function(){u=false});$(c).bind("touchstart",function(d){d.preventDefault()});$(c).bind("touchend",function(d){d.preventDefault()});$(c).bind("touchmove",function(d){d.preventDefault();t(d.originalEvent.touches[0]||d.originalEvent.changedTouches[0],this)})})});$(i).attr("src",b.target.result)}}(f);a.readAsDataURL(f)}}function handleDragOver(a){a.stopPropagation();a.preventDefault()}var dropZone=document.getElementById("drop_zone");
dropZone.addEventListener("dragover",handleDragOver,false);dropZone.addEventListener("drop",handleFileSelect,false);document.getElementById("files").addEventListener("change",handleFileSelect,false);$("output").mousedown(function(a){a.preventDefault()});$("#color").click(function(){setBrushCanvas(function(){return getImageCanvas(mainImage)},"color")});$(".draw").qtip({position:{corner:{target:"rightMiddle",tooltip:"leftMiddle"}},style:{name:"cream",tip:"leftMiddle",border:{width:2,radius:5}}});
$("#bw").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimBlackWhite()},"bw")});$("#red").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimRed()},"red")});$("#blue").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimBlue()},"blue")});$("#green").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimGreen()},"green")});
$("#yellow").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimYellow()},"yellow")});$("#magenta").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimMagenta()},"magenta")});$("#aqua").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimAqua()},"aqua")});$("#invert").click(function(){setBrushCanvas(function(){return $(getImageCanvas(mainImage)).inimInvert()},"invert")});$("#b").click(function(){brushsizer()});
$("#b").qtip({position:{corner:{target:"topMiddle",tooltip:"leftBottom"}},style:{name:"cream",tip:"bottomLeft",border:{width:2,radius:5}}});$("#d").click(function(){Canvas2Image.saveAsPNG($("#_canvas").get(0))});$("#d").qtip({position:{corner:{target:"topMiddle",tooltip:"leftBottom"}},style:{name:"cream",tip:"bottomLeft",border:{width:2,radius:5}}});$("#sizeofbrush").change(function(){brushsize=$(this).val();bsradius=Math.floor(brushsize/2);bsradius2=bsradius*bsradius});
var brushsizer=function(){var a=$("#b").get(0);$("#brushsize").get(0);var b=55;if($(window).width()-($(a).offset().left+b)<310&&$(a).offset().left+b>310)b=-310;$("#brushsize").toggle().css({position:"fixed",bottom:"68px",left:$(a).offset().left+b+"px"})};